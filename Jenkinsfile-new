pipeline {
    agent any

    environment {
        DOCKER_IMAGE_BASE = 'verifyttregistry.azurecr.io/registry'
        MANIFEST_REPO = 'https://github.com/iGovTT/VerifyTT-DevOps.git'
        MANIFEST_BRANCH = 'dev'
        JAVA_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'
        PATH = "${JAVA_HOME}/bin:${env.PATH}"
    }

    stages {
        // stage('Clone repository') {
        //     steps {
        //         git branch: 'v2.0.0', url: 'https://github.com/Aparnadeloitte/sunbird-rc-core', credentialsId: 'irwinwilliams'
        //     }
        // }

        stage('Compile And Test') {
            steps {
                sh 'sh configure-dependencies.sh'
                sh 'make'
                jacoco() // or your custom pattern if needed
            }
        }

        stage('Build Images') {
            steps {
                script {
                    app = docker.build("${DOCKER_IMAGE_BASE}/sunbird-rc-core", "target")
                    claimApp = docker.build("${DOCKER_IMAGE_BASE}/sunbird-rc-claim-ms", "java/claim")
                }
            }
        }

        stage('Push images') {
            steps {
                script {
                    withDockerRegistry([credentialsId: 'acr-admin-creds', url: 'https://verifyttregistry.azurecr.io']) {
                        app.push("${env.BUILD_NUMBER}")
                        app.push("latest")
                        claimApp.push("${env.BUILD_NUMBER}")
                        claimApp.push("latest")
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully! Images pushed."
        }
        failure {
            echo "Failed! Last attempted build."
        }
    }
}